<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Expense</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      .top-right {
        position: absolute;
        top: 10px;
        right: 10px;
      }
      .expense-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <button id="logoutButton" class="btn btn-danger top-right">Logout</button>
      <h2>Create Expense</h2>
      <form id="expenseForm">
        <div class="form-group">
          <label for="amount">Amount</label>
          <input type="number" class="form-control" id="amount" placeholder="Enter amount" required/>
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea class="form-control" id="description" rows="3" placeholder="Enter description" required></textarea>
        </div>
        <div class="form-group">
          <label for="expensetype">Expense Type</label>
          <select class="form-control" id="expensetype" required>
            <option value="Food">Food</option>
            <option value="Transportation">Transportation</option>
            <option value="Utilities">Utilities</option>
            <option value="Entertainment">Entertainment</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
        <!-- New Premium button -->
        <button id="premiumButton" class="btn btn-success ml-2">Go Premium</button>
      </form>
      <h3 class="mt-5">Expenses List</h3>
      <ul id="expenseList" class="list-group" style="max-height: 200px; overflow-y: auto; padding: 5px; border: 1px solid #ccc; border-radius: 5px;"></ul>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      document.getElementById("logoutButton").addEventListener("click", function () {
        localStorage.removeItem("jwtToken");
        window.location.href = "/home";
      });

      document.getElementById("expenseForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const amount = document.getElementById("amount").value;
        const description = document.getElementById("description").value;

        const expensetype = document.getElementById("expensetype").value;
        const token = localStorage.getItem("jwtToken");

        axios.post("/api/submitexpense", { amount, description, expensetype }, { headers: { Authorization: `Bearer ${token}` } })
          .then(response => {
            if (response.data && response.data.message === "Expense added successfully") {
              addExpenseToList(response.data.data);
              resetForm();
            }
          })
          .catch(error => console.error("Error creating expense:", error));
      });

      document.getElementById("premiumButton").addEventListener("click", function () {
        const token = localStorage.getItem("jwtToken");
   
    axios.post('/stripe-payments/create-stripe-session', {}, {
        headers: {
            'Authorization': `Bearer ${token}` // Properly format the header with your token
        }
    })
    .then(function (response) {
        // Redirect to Stripe's checkout page
        window.location.href = response.data.url;
    })
    .catch(function (error) {
        console.error('Error creating checkout session:', error);
        alert('Failed to initiate payment. Please try again.');
    });
});
     

      function addExpenseToList(expense) {
        const listItem = document.createElement("li");
        listItem.className = "list-group-item expense-item";
        listItem.innerHTML = `<div style="border: 1px solid #ccc; padding: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; max-width: 400px; width: 50%;"><div><strong>${expense.description}</strong><br><small class="text-muted">${expense.expensetype}</small></div><span class="badge badge-primary badge-pill" style="background-color: #007bff; padding: 5px 10px; border-radius: 20px; font-size: 14px;">$${expense.amount}</span><button class="btn btn-danger btn-sm ml-2 delete-btn" data-id="${expense.id}">Delete</button></div>`;
        document.getElementById("expenseList").appendChild(listItem);
        listItem.querySelector(".delete-btn").addEventListener("click", function () {
          deleteExpense(expense.id, listItem);
        });
      }

      function deleteExpense(id, listItem) {
        const token = localStorage.getItem("jwtToken");
        console.log(token);
        axios.delete(`/api/remove-exp/${id}`, { headers: { Authorization: `Bearer ${token}` } })
          .then(response => {
            console.log("Response:", response);
            if (response.status === 204) {
              listItem.remove();
            } else {
              console.error("Unexpected response:", response);
            }
          })
          .catch(error => console.error("Error deleting expense:", error));
      }

      document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("jwtToken");
        axios.get("/api/user-expenses", { headers: { Authorization: `Bearer ${token}` } })
          .then(response => {
            const expenses = response.data.data;
            expenses.forEach(expense => addExpenseToList(expense));
          })
          .catch(error => {
            console.error("Error fetching user expenses:", error);
          });
      });

      function resetForm() {
        document.getElementById("expenseForm").reset();
      }
    </script>
  </body>
</html>


